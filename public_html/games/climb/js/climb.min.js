/*
* Climb
*
* Copyright (c) 2014 Tarek Sherif
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as
* published by the Free Software Foundation, either version 3 of the
* License, or (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

(function(){var e=window.createBox=oFactory({draw:function(e){e.save();e.translate(this.x+this.width/2,this.y+this.height/2);e.rotate(this.rotation);e.scale(this.scale_x,this.scale_y);e.globalAlpha=this.alpha;e.lineWidth=this.lineWidth;e.fillStyle=this.color;e.beginPath();e.rect(-this.width/2,-this.height/2,this.width,this.height);e.fill();if(this.lineWidth>0){e.stroke()}e.restore()}}).mixin({color:"#FFFFFF",x:0,y:0,width:20,height:10,rotation:0,scale_x:1,scale_y:1,lineWidth:0,alpha:1})})();(function(){var e=window.createPlayer=createBox.clone().share({totalVX:function(){var e=this.vx;if(this.onplatform){e+=this.onplatform.vx}return e},totalVY:function(){var e=this.vy;if(this.onplatform){e+=this.onplatform.vy}return e},relativeVX:function(e){return this.totalVX()-e.vx},relativeVY:function(e){return this.totalVY()-e.vy}})})();(function(){var e=window.createPlatform=createBox.clone().share({translate:function(e,t){this.x+=e;this.y+=t;this.origin_x+=e;this.origin_y+=t;this.last_x+=e;this.last_y+=t;if(this.left_limit!==null)this.left_limit+=e;if(this.right_limit!==null)this.right_limit+=e;if(this.top_limit!==null)this.top_limit+=t;if(this.bottom_limit!==null)this.bottom_limit+=t},updatePosition:function(e){this.last_x=this.x;this.last_y=this.y;if(this.range_x){this.x=this.origin_x+Math.sin(e/1e3)*this.range_x}else{this.x=this.origin_x}if(this.range_y){this.y=this.origin_y+Math.sin(e/1e3)*this.range_y}else{this.y=this.origin_y}if(this.movingHorizontal()){if(this.left_limit!==null){if(this.x<=this.left_limit){this.x=this.left_limit}else{this.left_limit=null}}if(this.right_limit!==null){if(this.x>=this.right_limit){this.x=this.right_limit}else{this.right_limit=null}}}if(this.movingVertical()){if(this.top_limit!==null){if(this.y<=this.top_limit){this.y=this.top_limit}else{this.top_limit=null}}if(this.bottom_limit!==null){if(this.y>=this.bottom_limit){this.y=this.bottom_limit}else{this.bottom_limit=null}}}this.vx=this.x-this.last_x;this.vy=this.y-this.last_y},movingHorizontal:function(){return!!this.range_x},movingVertical:function(){return!!this.range_y}}).mixin({origin_x:null,origin_y:null,range_x:0,range_y:0,left_limit:null,right_limit:null,top_limit:null,bottom_limit:null}).init(function(e){if(typeof e.origin_x!=="number"){e.origin_x=e.x}if(typeof e.origin_y!=="number"){e.origin_y=e.y}})})();(function(){var e=window.createMessage=oFactory({draw:function(e){e.save();e.globalAlpha=this.alpha;e.font=this.font;e.fillStyle=this.color;e.textAlign=this.text_align;e.textBaseline=this.baseline;e.fillText(this.text,this.x,this.y);e.restore()}}).mixin({font:"bold 40px Helvetica",color:"#FFFFFF",text:"Message",x:0,y:0,alpha:1,baseline:"top"})})();(function(){"use strict;";function C(e,t,n,r){var i=createPlatform({x:Math.random()*(v.right-v.left-u)+v.left,y:e,width:Math.random()*u+1,height:Math.random()*u+1,color:h,range_x:Math.random()<.1?Math.random()*a:0,range_y:Math.random()<.1?Math.random()*a:0});if(i.range_x){if(i.origin_x-i.range_x<t){i.range_x=i.origin_x-t}else if(i.origin_x+i.width+i.range_x>n){i.range_x=n-i.width-i.origin_x}}if(i.range_y&&typeof r==="number"){if(i.origin_y+i.height+i.range_y>r){i.range_y=r-i.height-i.origin_y}}return i}function k(e,t){var n=e.width*.5;var r=e.height*.5;var i=t.width*.5;var s=t.height*.5;var o=e.relativeVX(t);var u=e.relativeVY(t);var a=Math.sqrt(o*o+u*u)||1;var f=o/a;var l=u/a;if(e.x+e.width<t.x)return null;if(e.y+e.height<t.y)return null;if(e.x>t.x+t.width)return null;if(e.y>t.y+t.height)return null;var c=Math.min(n,r);var h=c*f;var p=c*l;var d=e.x;var v=e.y;var m=e.last_x;var g=e.last_y;var y;var b;var w;if(h<0){b=function(e){return e>d}}else if(h>0){b=function(e){return e<d}}else{b=function(e){return false}}if(p<0){w=function(e){return e>v}}if(p>0){w=function(e){return e<v}}else{w=function(e){return false}}var E=0;while(b(m)||w(g)){e.x=m;e.y=g;y=tgame.collision.rectangle(e,t);if(y)break;m+=h;g+=p}e.x=d;e.y=v;y=y||tgame.collision.rectangle(e,t);if(!y)return null;var S=Math.max(Math.abs(o),1);var x=Math.max(Math.abs(u),1);var T=Math.max(.5,Math.min(S/x,1.5));var N;if(y.overlap_y*T<y.overlap_x){N=y.dy>0?"bottom":"top"}else{N=y.dx>0?"right":"left"}y.side=N;return y}function L(e,t){var n=t.left;var r=t.right;var i=t.top;var s=t.bottom;if(s&&!i){e.y=s.y-e.height;e.onplatform=s;e.vy=0}else if(i&&!s){e.y=i.y+i.height;e.vy=Math.max(0,i.vy)}else if(i&&s){if(s.range_y&&!i.range_y){e.y=i.y+i.height;s.y=e.y+e.height+.1;s.top_limit=s.y;if(s.range_x){if(s.vx<0){s.left_limit=s.x}else{s.right_limit=s.x}}}else if(!s.range_y&&i.range_y){e.y=s.y-e.height;i.y=e.y-i.height-.1;i.bottom_limit=i.y;if(i.range_x){if(i.vx<0){i.left_limit=i.x}else{i.right_limit=i.x}}}else if(s.range_y&&i.range_y){s.y=e.y+e.height;s.top_limit=s.y;if(s.range_x){if(s.vx<0){s.left_limit=s.x}else{s.right_limit=s.x}}i.y=e.y-i.height-.1;i.bottom_limit=i.y;if(i.range_x){if(i.vx<0){i.left_limit=i.x}else{i.right_limit=i.x}}}else{e.y=s.y-e.height;i.y=e.y-i.height-.1;i.origin_y=i.y}e.onplatform=s;e.vy=0}if(n&&!tgame.collision.rectangle(e,n))n=null;if(r&&!tgame.collision.rectangle(e,r))r=null;if(r&&!n){e.x=r.x-e.width;e.vx=Math.min(0,e.vx+r.vx)}else if(n&&!r){e.x=n.x+n.width;e.vx=Math.max(0,e.vx+n.vx)}else if(n&&r){if(r.range_x&&!n.range_x){e.x=n.x+n.width;r.x=e.x+e.width+.1;e.vx=Math.min(0,r.vx);r.left_limit=r.x;if(r.range_y){if(r.vy<0){r.top_limit=r.y}else{r.bottom_limit=r.y}}}else if(!r.range_x&&n.range_x){e.x=r.x-e.width;n.x=e.x-n.width-.1;e.vx=Math.max(0,n.vx);n.right_limit=n.x;if(n.range_y){if(n.vy<0){n.top_limit=n.y}else{n.bottom_limit=n.y}}}else if(r.range_x&&n.range_x){r.x=e.x+e.width+.1;r.left_limit=r.x;if(r.range_y){if(r.vy<0){r.top_limit=r.y}else{r.bottom_limit=r.y}}n.x=e.x-n.width-.1;n.right_limit=n.x;if(n.range_y){if(n.vy<0){n.top_limit=n.y}else{n.bottom_limit=n.y}}e.vx=0}else{if(n.y<r.y){e.x=n.x+n.width+.1;s=r}else{e.x=r.x-e.width-.1;s=n}e.y=s.y-e.height-.1;e.onplatform=s}}}var e=document.getElementById("canvas");e.width=800;e.height=600;var t=1.4;var n=.7;var r=7;var i=-25;var s=650;var o=75;var u=60;var a=200;var f=a*2;var l=.5;var c="#FF0000";var h="#0000FF";var p="#070707";var d,v,m;var g,y;var b,w;var E,S,x,T;var N=0;tgame.setFPS(40);tgame.clear_color="#000000";tgame.entities={player:[],platforms:[],walls:[],messages:[]};tgame.setRenderOrder(["walls","platforms","player","messages"]);tgame.addKeyControl(tgame.keyboard.LEFT,function(){d.move_left=true},function(){d.move_left=false});tgame.addKeyControl(tgame.keyboard.RIGHT,function(){d.move_right=true},function(){d.move_right=false});tgame.addKeyControl(tgame.keyboard.SPACE,function(){if(!d.jumping&&d.onplatform){d.jump=true;d.jumping=true}},function(){d.jumping=false});tgame.addKeyControl(tgame.keyboard.R,function(e){if(e.ctrlKey)return false;E.hidden=true;S.hidden=true;x.hidden=true;T.hidden=true;tgame.state="CLEAR_ROUND"});tgame.addSound("music","audio/bellahmer-round1");tgame.addSound("jump","audio/jump");tgame.setCanvas(e);tgame.STATES={INIT:function(){var t,n,r;var i,u;m=(e.width-s)/2;v={top:0,left:m,bottom:e.height,right:e.width-m,top_boundary:e.height*.25};t=createMessage({x:(v.left+v.right)*.5,y:(v.top+v.bottom)*.5-o*.5,color:"#FF0000",font:"normal 128px telegrama",baseline:"middle",text_align:"center",text:"Climb"});n=createMessage({x:t.x,y:t.y+72,font:"normal 18px telegrama",baseline:"top",text_align:"center",text:"by Tarek Sherif"});r=createMessage({x:t.x,y:t.y+96,font:"normal 18px telegrama",baseline:"top",text_align:"center",text:"Music by Nadir Bellahmer"});i=createMessage({x:v.left+10,y:v.bottom-o-10,font:"normal 18px telegrama",baseline:"bottom",text_align:"left",hidden:true,text:"← → to Move"});u=createMessage({x:v.right-10,y:v.bottom-o-10,font:"normal 18px telegrama",baseline:"bottom",text_align:"right",hidden:true,text:"SPACE to Jump"});tgame.entities.messages.push(t);tgame.entities.messages.push(n);tgame.entities.messages.push(r);tgame.entities.messages.push(i);tgame.entities.messages.push(u);tgame.effects.fade({objects:[t,n,r],ratio:.95,delay:1e3,remove:true,complete:function(){i.hidden=false;i.alpha=0;u.hidden=false;u.alpha=0;tgame.effects.fade({objects:[i,u],ratio:1.4,complete:function(){u.hidden=false;tgame.effects.fade({objects:[i,u],ratio:.95,delay:3200,remove:true})}})}});tgame.sounds.music.currentTime=0;tgame.sounds.music.loop=true;tgame.sounds.music.volume=.5;tgame.sounds.music.play();tgame.sounds.jump.volume=.1;localStorage.high_score=localStorage.high_score||0;tgame.getCanvas().focus();tgame.state="START_ROUND"},CLEAR_ROUND:function(){tgame.clearEntities();tgame.state="START_ROUND"},START_ROUND:function(){var t,n;d=createPlayer({color:c,x:e.width/2,y:e.height-o-30,width:15,height:30,vx:0,vy:0,ax:0,ay:0,onplatform:null,move_left:false,move_right:false,jump:false,jumping:false,last_x:0,last_y:0});tgame.entities.player.push(d);tgame.entities.walls.push(createPlatform({x:0,y:0,width:m,height:e.height,color:p}));tgame.entities.walls.push(createPlatform({x:v.right,y:0,width:m,height:e.height,color:p}));tgame.entities.platforms.push(createPlatform({x:0,y:e.height-o,width:e.width,height:o,color:p}));n=Math.floor(Math.random()*60+30);while(n--){tgame.entities.platforms.push(C(Math.random()*(v.bottom-o-u+f)-f,v.left,v.right,v.bottom-o))}g=0;y=createMessage({x:v.right-10,y:v.top+10,font:"normal 18px telegrama",text_align:"right",text:"Height: "+g});b=g;w=createMessage({x:v.right-10,y:v.top+34,font:"normal 18px telegrama",text_align:"right",text:"Max Height: "+b});E=createMessage({x:(v.left+v.right)*.5,y:(v.top+v.bottom)*.5-o*.5,font:"normal 64px telegrama",color:"#FF0000",baseline:"middle",text_align:"center",text:"GAME OVER",hidden:true});S=createMessage({x:E.x,y:E.y+40,font:"normal 18px telegrama",baseline:"top",text:"Maximum Height This Round: ",text_align:"center",hidden:true});x=createMessage({x:E.x,y:E.y+64,font:"normal 18px telegrama",baseline:"top",text:"Maximum Height All Time: ",text_align:"center",hidden:true});T=createMessage({x:E.x,y:E.y+88,font:"normal 18px telegrama",baseline:"top",text:"Press 'R' to Restart",text_align:"center",hidden:true});tgame.entities.messages.push(y);tgame.entities.messages.push(w);tgame.entities.messages.push(E);tgame.entities.messages.push(S);tgame.entities.messages.push(x);tgame.entities.messages.push(T);tgame.state="PLAY"},PLAY:function(){var e={};d.last_x=d.x;d.last_y=d.y;d.ax=0;if(d.move_left&&!d.move_right){d.vx=Math.min(d.vx,0);d.ax=-.5}else if(!d.move_left&&d.move_right){d.vx=Math.max(d.vx,0);d.ax=.5}if(d.jump){d.vy=i;d.onplatform=null;d.jump=false;tgame.sounds.jump.currentTime=0;tgame.sounds.jump.play()}if(d.ax){d.vx=Math.max(-r,Math.min(d.vx+d.ax,r))}else if(d.onplatform){d.vx=0}else{d.vx*=n}d.vy+=t;d.x+=d.vx;d.y+=d.vy;if(d.x<v.left){d.x=v.left;d.vx=0}if(d.x+d.width>v.right){d.x=v.right-d.width}d.y+=N;if(N>0&&Math.random()<l){tgame.entities.platforms.push(C(v.top-f,v.left,v.right))}tgame.entities.platforms.forEach(function(t){t.translate(0,N);if(t.origin_y-t.range_y>v.bottom){t.remove=true}t.updatePosition(Date.now());var n=k(d,t);var r=n?n.side:null;if(n){if(r==="bottom"){if(!e.bottom||t.y<e.bottom.y){e.bottom=t}}if(r==="top"){if(!e.top||t.y>e.top.y){e.top=t}}if(r==="left"){if(!e.left||t.x>e.left.x){e.left=t}}if(r==="right"){if(!e.right||t.x<e.right.x){e.right=t}}}});L(d,e);if(d.onplatform){d.x+=d.onplatform.vx;d.y=d.onplatform.y-d.height;d.vy=0;if(d.x+d.width<d.onplatform.x+Math.min(2*d.vx,0)||d.x>d.onplatform.x+d.onplatform.width+Math.max(2*d.vx,0)){d.onplatform=null}}N=Math.max(0,v.top_boundary-d.y);g=Math.max(0,Math.round(g-d.y+d.last_y+N));g=g<10?0:g;y.text="Height: "+g;b=Math.max(b,g);w.text="Max height: "+b;if(d.y>v.bottom+f){tgame.state="OVER"}},OVER:function(){localStorage.high_score=Math.max(parseInt(localStorage.high_score,10),b);E.hidden=false;S.text="Maximum Height This Round: "+b;S.hidden=false;x.text="Maximum Height All Time: "+localStorage.high_score;x.hidden=false;T.hidden=false;tgame.state="PLAY"}};tgame.state="INIT";tgame.start()})()
