/*
climb v1.0.1 

Copyright (C) 2014 Tarek Sherif 

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
!function(){"use strict";window.createBox=oFactory({draw:function(a){a.save(),a.translate(this.x+this.width/2,this.y+this.height/2),a.rotate(this.rotation),a.scale(this.scale_x,this.scale_y),a.globalAlpha=this.alpha,a.lineWidth=this.lineWidth,a.fillStyle=this.color,a.beginPath(),a.rect(-this.width/2,-this.height/2,this.width,this.height),a.fill(),this.lineWidth>0&&a.stroke(),a.restore()}}).mixin({color:"#FFFFFF",x:0,y:0,width:20,height:10,rotation:0,scale_x:1,scale_y:1,lineWidth:0,alpha:1})}(),function(){"use strict";window.createPlayer=createBox.clone().share({animate:function(){var a=Math.abs(this.vx),b=Math.abs(Math.min(this.vy,0)),c=1+a/50,d=1+b/50;this.width=this.base_width*c/d,this.height=this.base_height*d/c},totalVX:function(){var a=this.vx;return this.onplatform&&(a+=this.onplatform.vx),a},totalVY:function(){var a=this.vy;return this.onplatform&&(a+=this.onplatform.vy),a},relativeVX:function(a){return this.totalVX()-a.vx},relativeVY:function(a){return this.totalVY()-a.vy}}).init(function(){this.base_width=this.width,this.base_height=this.height})}(),function(){"use strict";window.createPlatform=createBox.clone().share({translate:function(a,b){this.x+=a,this.y+=b,this.origin_x+=a,this.origin_y+=b,this.last_x+=a,this.last_y+=b,null!==this.left_limit&&(this.left_limit+=a),null!==this.right_limit&&(this.right_limit+=a),null!==this.top_limit&&(this.top_limit+=b),null!==this.bottom_limit&&(this.bottom_limit+=b)},updatePosition:function(a){this.last_x=this.x,this.last_y=this.y,this.x=this.range_x?this.origin_x+Math.sin(a/1e3)*this.range_x:this.origin_x,this.y=this.range_y?this.origin_y+Math.sin(a/1e3)*this.range_y:this.origin_y,this.movingHorizontal()&&(null!==this.left_limit&&(this.x<=this.left_limit?this.x=this.left_limit:this.left_limit=null),null!==this.right_limit&&(this.x>=this.right_limit?this.x=this.right_limit:this.right_limit=null)),this.movingVertical()&&(null!==this.top_limit&&(this.y<=this.top_limit?this.y=this.top_limit:this.top_limit=null),null!==this.bottom_limit&&(this.y>=this.bottom_limit?this.y=this.bottom_limit:this.bottom_limit=null)),this.vx=this.x-this.last_x,this.vy=this.y-this.last_y},movingHorizontal:function(){return!!this.range_x},movingVertical:function(){return!!this.range_y}}).mixin({origin_x:null,origin_y:null,range_x:0,range_y:0,left_limit:null,right_limit:null,top_limit:null,bottom_limit:null}).init(function(a){"number"!=typeof a.origin_x&&(a.origin_x=a.x),"number"!=typeof a.origin_y&&(a.origin_y=a.y)})}(),function(){"use strict";window.createMessage=oFactory({draw:function(a){a.save(),a.globalAlpha=this.alpha,a.font=this.font,a.fillStyle=this.color,a.textAlign=this.text_align,a.textBaseline=this.baseline,a.fillText(this.text,this.x,this.y),a.restore()}}).mixin({font:"bold 40px Helvetica",color:"#FFFFFF",text:"Message",x:0,y:0,alpha:1,baseline:"top"})}(),function(){"use strict";function a(a,b,c,d){var e=createPlatform({x:Math.random()*(f.right-f.left-v)+f.left,y:a,width:Math.random()*v+1,height:Math.random()*v+1,color:A,range_x:Math.random()<.1?Math.random()*w:0,range_y:Math.random()<.1?Math.random()*w:0});return e.range_x&&(e.origin_x-e.range_x<b?e.range_x=e.origin_x-b:e.origin_x+e.width+e.range_x>c&&(e.range_x=c-e.width-e.origin_x)),e.range_y&&"number"==typeof d&&e.origin_y+e.height+e.range_y>d&&(e.range_y=d-e.height-e.origin_y),e}function b(a,b){var c=.5*a.width,d=.5*a.height,e=a.relativeVX(b),f=a.relativeVY(b),g=Math.sqrt(e*e+f*f)||1,h=e/g,i=f/g;if(a.x+a.width<b.x)return null;if(a.y+a.height<b.y)return null;if(a.x>b.x+b.width)return null;if(a.y>b.y+b.height)return null;var j,k,l,m=Math.min(c,d),n=m*h,o=m*i,p=a.x,q=a.y,r=a.last_x,s=a.last_y;for(k=0>n?function(a){return a>p}:n>0?function(a){return p>a}:function(){return!1},l=0>o?function(a){return a>q}:o>0?function(a){return q>a}:function(){return!1};(k(r)||l(s))&&(a.x=r,a.y=s,!(j=tgame.collision.rectangle(a,b)));)r+=n,s+=o;if(a.x=p,a.y=q,j=j||tgame.collision.rectangle(a,b),!j)return null;var t,u=Math.max(Math.abs(e),1),v=Math.max(Math.abs(f),1),w=Math.max(.5,Math.min(u/v,1.5));return t=j.overlap_y*w<j.overlap_x?j.dy>0?"bottom":"top":j.dx>0?"right":"left",j.side=t,j}function c(a,b){var c=b.left,d=b.right,e=b.top,f=b.bottom;f&&!e?(a.y=f.y-a.height,a.onplatform=f,a.vy=0):e&&!f?(a.y=e.y+e.height,a.vy=Math.max(0,e.vy)):e&&f&&(f.range_y&&!e.range_y?(a.y=e.y+e.height,f.y=a.y+a.height+.1,f.top_limit=f.y,f.range_x&&(f.vx<0?f.left_limit=f.x:f.right_limit=f.x)):!f.range_y&&e.range_y?(a.y=f.y-a.height,e.y=a.y-e.height-.1,e.bottom_limit=e.y,e.range_x&&(e.vx<0?e.left_limit=e.x:e.right_limit=e.x)):f.range_y&&e.range_y?(f.y=a.y+a.height,f.top_limit=f.y,f.range_x&&(f.vx<0?f.left_limit=f.x:f.right_limit=f.x),e.y=a.y-e.height-.1,e.bottom_limit=e.y,e.range_x&&(e.vx<0?e.left_limit=e.x:e.right_limit=e.x)):(a.y=f.y-a.height,e.y=a.y-e.height-.1,e.origin_y=e.y),a.onplatform=f,a.vy=0),c&&!tgame.collision.rectangle(a,c)&&(c=null),d&&!tgame.collision.rectangle(a,d)&&(d=null),d&&!c?(a.x=d.x-a.width,a.vx=Math.min(0,a.vx+d.vx)):c&&!d?(a.x=c.x+c.width,a.vx=Math.max(0,a.vx+c.vx)):c&&d&&(d.range_x&&!c.range_x?(a.x=c.x+c.width,d.x=a.x+a.width+.1,a.vx=Math.min(0,d.vx),d.left_limit=d.x,d.range_y&&(d.vy<0?d.top_limit=d.y:d.bottom_limit=d.y)):!d.range_x&&c.range_x?(a.x=d.x-a.width,c.x=a.x-c.width-.1,a.vx=Math.max(0,c.vx),c.right_limit=c.x,c.range_y&&(c.vy<0?c.top_limit=c.y:c.bottom_limit=c.y)):d.range_x&&c.range_x?(d.x=a.x+a.width+.1,d.left_limit=d.x,d.range_y&&(d.vy<0?d.top_limit=d.y:d.bottom_limit=d.y),c.x=a.x-c.width-.1,c.right_limit=c.x,c.range_y&&(c.vy<0?c.top_limit=c.y:c.bottom_limit=c.y),a.vx=0):(c.y<d.y?(a.x=c.x+c.width+.1,f=d):(a.x=d.x-a.width-.1,f=c),a.y=f.y-a.height-.1,a.onplatform=f))}var d=document.getElementById("canvas");d.width=800,d.height=600;var e,f,g,h,i,j,k,l,m,n,o,p=1.4,q=.7,r=7,s=-25,t=650,u=75,v=60,w=200,x=2*w,y=.5,z="#FF0000",A="#0000FF",B="#070707",C=0;tgame.setFPS(40),tgame.clear_color="#000000",tgame.entities={player:[],platforms:[],walls:[],messages:[]},tgame.setRenderOrder(["walls","platforms","player","messages"]),tgame.addKeyControl(tgame.keyboard.LEFT,function(){e.move_left=!0},function(){e.move_left=!1}),tgame.addKeyControl(tgame.keyboard.RIGHT,function(){e.move_right=!0},function(){e.move_right=!1}),tgame.addKeyControl(tgame.keyboard.SPACE,function(){!e.jumping&&e.onplatform&&(e.jump=!0,e.jumping=!0)},function(){e.jumping=!1}),tgame.addKeyControl(tgame.keyboard.R,function(a){return a.ctrlKey?!1:(l.hidden=!0,m.hidden=!0,n.hidden=!0,o.hidden=!0,void(tgame.state="CLEAR_ROUND"))}),tgame.addSound("music","audio/bellahmer-round1"),tgame.addSound("jump","audio/jump"),tgame.setCanvas(d),tgame.STATES={INIT:function(){var a,b,c,e,h;g=(d.width-t)/2,f={top:0,left:g,bottom:d.height,right:d.width-g,top_boundary:.25*d.height},a=createMessage({x:.5*(f.left+f.right),y:.5*(f.top+f.bottom)-.5*u,color:"#FF0000",font:"normal 128px telegrama",baseline:"middle",text_align:"center",text:"Climb"}),b=createMessage({x:a.x,y:a.y+72,font:"normal 18px telegrama",baseline:"top",text_align:"center",text:"by Tarek Sherif"}),c=createMessage({x:a.x,y:a.y+96,font:"normal 18px telegrama",baseline:"top",text_align:"center",text:"Music by Nadir Bellahmer"}),e=createMessage({x:f.left+10,y:f.bottom-u-10,font:"normal 18px telegrama",baseline:"bottom",text_align:"left",hidden:!0,text:"← → to Move"}),h=createMessage({x:f.right-10,y:f.bottom-u-10,font:"normal 18px telegrama",baseline:"bottom",text_align:"right",hidden:!0,text:"SPACE to Jump"}),tgame.entities.messages.push(a),tgame.entities.messages.push(b),tgame.entities.messages.push(c),tgame.entities.messages.push(e),tgame.entities.messages.push(h),tgame.effects.fade({objects:[a,b,c],ratio:.95,delay:1e3,remove:!0,complete:function(){e.hidden=!1,e.alpha=0,h.hidden=!1,h.alpha=0,tgame.effects.fade({objects:[e,h],ratio:1.4,complete:function(){h.hidden=!1,tgame.effects.fade({objects:[e,h],ratio:.95,delay:3200,remove:!0})}})}}),tgame.sounds.music.currentTime=0,tgame.sounds.music.loop=!0,tgame.sounds.music.volume=.5,tgame.sounds.music.play(),tgame.sounds.jump.volume=.1,localStorage.high_score=localStorage.high_score||0,tgame.getCanvas().focus(),tgame.state="START_ROUND"},CLEAR_ROUND:function(){tgame.clearEntities(),tgame.state="START_ROUND"},START_ROUND:function(){var b;for(e=createPlayer({color:z,x:d.width/2,y:d.height-u-30,width:15,height:30,vx:0,vy:0,ax:0,ay:0,onplatform:null,move_left:!1,move_right:!1,jump:!1,jumping:!1,last_x:0,last_y:0}),tgame.entities.player.push(e),tgame.entities.walls.push(createPlatform({x:0,y:0,width:g,height:d.height,color:B})),tgame.entities.walls.push(createPlatform({x:f.right,y:0,width:g,height:d.height,color:B})),tgame.entities.platforms.push(createPlatform({x:0,y:d.height-u,width:d.width,height:u,color:B})),b=Math.floor(60*Math.random()+30);b--;)tgame.entities.platforms.push(a(Math.random()*(f.bottom-u-v+x)-x,f.left,f.right,f.bottom-u));h=0,i=createMessage({x:f.right-10,y:f.top+10,font:"normal 18px telegrama",text_align:"right",text:"Height: "+h}),j=h,k=createMessage({x:f.right-10,y:f.top+34,font:"normal 18px telegrama",text_align:"right",text:"Max Height: "+j}),l=createMessage({x:.5*(f.left+f.right),y:.5*(f.top+f.bottom)-.5*u,font:"normal 64px telegrama",color:"#FF0000",baseline:"middle",text_align:"center",text:"GAME OVER",hidden:!0}),m=createMessage({x:l.x,y:l.y+40,font:"normal 18px telegrama",baseline:"top",text:"Maximum Height This Round: ",text_align:"center",hidden:!0}),n=createMessage({x:l.x,y:l.y+64,font:"normal 18px telegrama",baseline:"top",text:"Maximum Height All Time: ",text_align:"center",hidden:!0}),o=createMessage({x:l.x,y:l.y+88,font:"normal 18px telegrama",baseline:"top",text:"Press 'R' to Restart",text_align:"center",hidden:!0}),tgame.entities.messages.push(i),tgame.entities.messages.push(k),tgame.entities.messages.push(l),tgame.entities.messages.push(m),tgame.entities.messages.push(n),tgame.entities.messages.push(o),tgame.state="PLAY"},PLAY:function(){var d={};e.last_x=e.x,e.last_y=e.y,e.ax=0,e.move_left&&!e.move_right?(e.vx=Math.min(e.vx,0),e.ax=-.5):!e.move_left&&e.move_right&&(e.vx=Math.max(e.vx,0),e.ax=.5),e.jump&&(e.vy=s,e.onplatform=null,e.jump=!1,tgame.sounds.jump.currentTime=0,tgame.sounds.jump.play()),e.ax?e.vx=Math.max(-r,Math.min(e.vx+e.ax,r)):e.onplatform?e.vx=0:e.vx*=q,e.vy+=p,e.x+=e.vx,e.y+=e.vy,e.animate(),e.x<f.left&&(e.x=f.left,e.vx=0),e.x+e.width>f.right&&(e.x=f.right-e.width),e.y+=C,C>0&&Math.random()<y&&tgame.entities.platforms.push(a(f.top-x,f.left,f.right)),tgame.entities.platforms.forEach(function(a){a.translate(0,C),a.origin_y-a.range_y>f.bottom&&(a.remove=!0),a.updatePosition(Date.now());var c=b(e,a),g=c?c.side:null;c&&("bottom"===g&&(!d.bottom||a.y<d.bottom.y)&&(d.bottom=a),"top"===g&&(!d.top||a.y>d.top.y)&&(d.top=a),"left"===g&&(!d.left||a.x>d.left.x)&&(d.left=a),"right"===g&&(!d.right||a.x<d.right.x)&&(d.right=a))}),c(e,d),e.onplatform&&(e.x+=e.onplatform.vx,e.y=e.onplatform.y-e.height,e.vy=0,(e.x+e.width<e.onplatform.x+Math.min(2*e.vx,0)||e.x>e.onplatform.x+e.onplatform.width+Math.max(2*e.vx,0))&&(e.onplatform=null)),C=Math.max(0,f.top_boundary-e.y),h=Math.max(0,Math.round(h-e.y+e.last_y+C)),h=10>h?0:h,i.text="Height: "+h,j=Math.max(j,h),k.text="Max height: "+j,e.y>f.bottom+x&&(tgame.state="OVER")},OVER:function(){localStorage.high_score=Math.max(parseInt(localStorage.high_score,10),j),l.hidden=!1,m.text="Maximum Height This Round: "+j,m.hidden=!1,n.text="Maximum Height All Time: "+localStorage.high_score,n.hidden=!1,o.hidden=!1,tgame.state="PLAY"}},tgame.state="INIT",tgame.start()}();